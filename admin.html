<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Village Grocery</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* =========================================
   MODERN DASHBOARD VARIABLES
   ========================================= */
:root {
  --primary: #059669;       /* Modern Emerald Green */
  --primary-dark: #047857;
  --primary-light: #d1fae5;
  --secondary: #f59e0b;     /* Amber */
  --bg-body: #f3f4f6;       /* Light Cool Gray */
  --bg-card: #ffffff;
  --text-main: #111827;     /* Deep Black/Blue */
  --text-sub: #6b7280;      /* Cool Gray */
  --border: #e5e7eb;
  
  /* Status Colors */
  --status-new-bg: #fee2e2;
  --status-new-text: #ef4444;
  --status-prog-bg: #dbeafe;
  --status-prog-text: #3b82f6;
  --status-done-bg: #d1fae5;
  --status-done-text: #059669;
  --status-cancel-bg: #f3f4f6;
  --status-cancel-text: #9ca3af;

  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --radius: 12px;
  --radius-lg: 16px;
  --transition: all 0.2s ease-in-out;
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

body {
  font-family: 'Poppins', sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* =========================================
   HEADER & NAV
   ========================================= */
header {
  background: var(--bg-card);
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 50;
  box-shadow: var(--shadow-sm);
  border-bottom: 1px solid var(--border);
}

.brand {
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.brand span { color: var(--text-main); }

/* Sound Toggle */
#soundToggleBtn {
  background: var(--bg-body);
  border: 1px solid var(--border);
  width: 40px; 
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-size: 1.2rem;
  transition: var(--transition);
}
#soundToggleBtn:hover { transform: scale(1.05); background: #e5e7eb; }
#soundToggleBtn.muted::after { content: "üîï"; opacity: 0.6; }
#soundToggleBtn:not(.muted)::after { content: "üîî"; }

/* =========================================
   LOGIN SCREEN
   ========================================= */
#loginBox {
  max-width: 400px;
  margin: 100px auto 20px;
  background: var(--bg-card);
  padding: 40px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  text-align: center;
  border: 1px solid var(--border);
  animation: slideUp 0.5s ease;
}

@keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

#loginBox h3 { font-size: 1.5rem; margin-bottom: 8px; color: var(--text-main); }
#loginBox p { color: var(--text-sub); font-size: 0.9rem; margin-bottom: 24px; }

#googleBtn {
  width: 100%;
  padding: 12px;
  background: #fff;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  font-weight: 600;
  color: var(--text-main);
  cursor: pointer;
  transition: var(--transition);
}
#googleBtn:hover { background: #f9fafb; border-color: #d1d5db; }
#googleBtn img { width: 20px; }

/* =========================================
   ADMIN DASHBOARD CONTENT
   ========================================= */
#adminContent { display: none; padding: 24px; max-width: 1200px; margin: 0 auto; }

.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.admin-header h3 { font-size: 1.5rem; font-weight: 700; }

#logoutBtn {
  padding: 8px 20px;
  background: #fee2e2;
  color: #ef4444;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  cursor: pointer;
  font-size: 0.9rem;
  transition: var(--transition);
}
#logoutBtn:hover { background: #fecaca; }

/* STATS GRID */
.stats-bar {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}

.stat-card {
  background: var(--bg-card);
  padding: 20px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  transition: var(--transition);
}
.stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

.stat-label { font-size: 0.85rem; font-weight: 500; color: var(--text-sub); margin-bottom: 4px; }
.stat-value { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }

/* Color accents for stats */
.stat-card:nth-child(1) .stat-value { color: var(--primary); }
.stat-card:nth-child(2) .stat-value { color: #f59e0b; }
.stat-card:nth-child(3) .stat-value { color: #3b82f6; }
.stat-card:nth-child(4) .stat-value { color: var(--text-main); }

/* FILTERS */
.filter-bar {
  background: #e5e7eb;
  padding: 4px;
  border-radius: var(--radius);
  display: inline-flex;
  gap: 4px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 8px 20px;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: var(--text-sub);
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: var(--transition);
}

.filter-btn:hover { color: var(--text-main); }
.filter-btn.active { background: white; color: var(--primary); box-shadow: var(--shadow-sm); }

/* =========================================
   ORDER CARD DESIGN (PREMIUM)
   ========================================= */
#ordersList { display: flex; flex-direction: column; gap: 20px; }

.order-card {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  transition: var(--transition);
  animation: fadeIn 0.4s ease;
}
@keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

.order-card:hover { box-shadow: var(--shadow-md); border-color: #d1d5db; }

/* Card Header */
.card-header-strip {
  padding: 16px 24px;
  background: #f9fafb;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.order-id { font-family: monospace; font-weight: 600; color: var(--text-sub); font-size: 0.9rem; }
.order-meta { display: flex; gap: 12px; align-items: center; }
.order-date { font-size: 0.85rem; color: var(--text-sub); font-weight: 500; }

/* Status Badge */
.status-badge {
  padding: 4px 12px;
  border-radius: 99px;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.status-badge.new { background: var(--status-new-bg); color: var(--status-new-text); }
.status-badge.inprogress { background: var(--status-prog-bg); color: var(--status-prog-text); }
.status-badge.delivered { background: var(--status-done-bg); color: var(--status-done-text); }
.status-badge.cancelled { background: var(--status-cancel-bg); color: var(--status-cancel-text); }

/* Card Body */
.card-body { padding: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }

@media(max-width: 768px) { .card-body { grid-template-columns: 1fr; } }

/* Customer Info Column */
.customer-info h4 { font-size: 0.85rem; text-transform: uppercase; color: var(--text-sub); letter-spacing: 1px; margin-bottom: 12px; }
.info-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
.info-icon { font-size: 1.1rem; }
.info-text { font-size: 0.95rem; color: var(--text-main); font-weight: 500; }
.info-text.sub { font-size: 0.9rem; color: var(--text-sub); font-weight: 400; }

.location-box {
  margin-top: 12px;
  background: #ecfdf5;
  padding: 8px 12px;
  border-radius: 8px;
  color: var(--primary-dark);
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #d1fae5;
}

/* Order Details Column */
.order-details-box {
  background: #f9fafb;
  border-radius: var(--radius);
  padding: 16px;
  border: 1px solid var(--border);
}

.order-item-list { list-style: none; margin-bottom: 16px; max-height: 200px; overflow-y: auto; }
.order-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px dashed var(--border);
  font-size: 0.9rem;
}
.order-item:last-child { border-bottom: none; }
.item-qty { font-weight: 600; color: var(--text-main); margin-right: 8px; }
.item-name { color: var(--text-main); flex: 1; }
.item-price { font-weight: 600; color: var(--text-sub); }

.order-total-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 12px;
  border-top: 2px solid var(--border);
  font-size: 1.1rem;
}
.total-label { font-weight: 600; color: var(--text-sub); }
.total-amount { font-weight: 700; color: var(--primary); }

/* Card Footer (Actions) */
.card-footer {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  background: #fff;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  flex-wrap: wrap;
}

.action-btn {
  padding: 10px 20px;
  border-radius: 8px;
  border: 1px solid transparent;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-new { background: white; border-color: var(--status-new-text); color: var(--status-new-text); }
.btn-new:hover { background: var(--status-new-bg); }

.btn-prog { background: white; border-color: var(--status-prog-text); color: var(--status-prog-text); }
.btn-prog:hover { background: var(--status-prog-bg); }

.btn-done { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(5, 150, 105, 0.2); }
.btn-done:hover { background: var(--primary-dark); transform: translateY(-1px); }

.btn-cancel { background: transparent; color: var(--text-sub); }
.btn-cancel:hover { background: #f3f4f6; color: var(--text-main); }

/* =========================================
   NOTIFICATIONS & MODALS
   ========================================= */
.status-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #333;
  color: white;
  padding: 12px 24px;
  border-radius: 50px;
  box-shadow: var(--shadow-md);
  z-index: 1000;
  display: none;
  font-size: 0.9rem;
  animation: slideIn 0.3s ease;
}
@keyframes slideIn { from{transform:translateX(100%);} to{transform:translateX(0);} }

/* New Order Notification */
.new-order-alert {
  position: fixed;
  top: 24px;
  left: 50%;
  transform: translateX(-50%);
  background: #111827;
  color: #fff;
  padding: 12px 24px;
  border-radius: 99px;
  display: none;
  align-items: center;
  gap: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  z-index: 2000;
  cursor: pointer;
  animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes bounceIn { 0%{transform:translate(-50%, -20px); opacity:0;} 100%{transform:translate(-50%, 0); opacity:1;} }

.alert-badge { background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 700; }

/* Empty State */
.empty-state {
  text-align: center;
  padding: 80px 20px;
  color: var(--text-sub);
}
.empty-icon { font-size: 3rem; margin-bottom: 16px; display: block; opacity: 0.5; }

/* Code Panel (Hidden mostly) */
.code-panel { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; }
.code-content { position: absolute; right: 0; top: 0; bottom: 0; width: 500px; background: #1e1e1e; padding: 20px; overflow: auto; color: #ccc; }
.code-toggle { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; opacity: 0.5; }

/* Responsive Adjustments */
@media (max-width: 600px) {
  .admin-header { flex-direction: column; align-items: flex-start; gap: 12px; }
  .filter-bar { width: 100%; justify-content: space-between; }
  .filter-btn { flex: 1; text-align: center; padding: 8px 4px; font-size: 0.8rem; }
  .card-footer { justify-content: stretch; }
  .action-btn { flex: 1; justify-content: center; }
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <span>üë®‚Äçüíº</span> Village Grocery <span>Admin</span>
  </div>
  <button id="soundToggleBtn" title="Toggle Sound Notifications"></button>
</header>

<div id="statusFeedback" class="status-toast">
  ‚úÖ Status Updated
</div>

<div id="newOrderCounter" class="new-order-alert">
  <span>üîî New Order Received!</span>
  <span class="alert-badge" id="newOrderCount">1</span>
</div>

<div id="loginBox">
  <h3>Welcome Back</h3>
  <p>Please sign in to access the dashboard.</p>
  <button id="googleBtn">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
    <span>Sign in with Google</span>
  </button>
</div>

<div id="adminContent">
  
  <div class="admin-header">
    <h3>Dashboard Overview</h3>
    <button id="logoutBtn">Sign Out</button>
  </div>

  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-label">Total Orders</div>
      <div class="stat-value" id="totalOrders">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Pending</div>
      <div class="stat-value" id="pendingOrders">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Delivered</div>
      <div class="stat-value" id="deliveredOrders">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Today</div>
      <div class="stat-value" id="todayOrders">0</div>
    </div>
  </div>

  <div class="filter-bar">
    <button class="filter-btn active" onclick="filterOrders('ALL')">All Orders</button>
    <button class="filter-btn" onclick="filterOrders('NEW')">New</button>
    <button class="filter-btn" onclick="filterOrders('INPROGRESS')">Processing</button>
    <button class="filter-btn" onclick="filterOrders('DELIVERED')">Completed</button>
  </div>

  <div id="ordersList" class="loading">Loading...</div>

</div>

<div id="codePanel" class="code-panel">
  <div class="code-content">
    <h3>Code Viewer</h3>
    <button onclick="toggleCodePanel()">Close</button>
    <pre><code>// Config is secure</code></pre>
  </div>
</div>
<button class="code-toggle" onclick="toggleCodePanel()">üíª</button>

<div id="soundNotification" style="display:none"></div>
<button id="confirmSoundBtn" style="display:none"></button>
<button id="viewOrderBtn" style="display:none"></button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, onSnapshot, orderBy, query, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged,
  GoogleAuthProvider,
  signInWithPopup,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// --- FIREBASE CONFIG (SAME AS BEFORE) ---
const firebaseConfig = {
  apiKey: "AIzaSyCYDLsQLFvuTV1N0mXtZFVYcSQqOkGfCrE",
  authDomain: "grocery-orders-3ce26.firebaseapp.com",
  projectId: "grocery-orders-3ce26",
  storageBucket: "grocery-orders-3ce26.appspot.com",
  messagingSenderId: "786501136156",
  appId: "1:786501136156:web:9277a2f7ef937deff1d4d9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// DOM Elements
const loginBox = document.getElementById("loginBox");
const adminContent = document.getElementById("adminContent");
const ordersList = document.getElementById("ordersList");
const googleBtn = document.getElementById("googleBtn");
const logoutBtn = document.getElementById("logoutBtn");
const statusFeedback = document.getElementById("statusFeedback");
const soundToggleBtn = document.getElementById("soundToggleBtn");
const newOrderCounter = document.getElementById("newOrderCounter");
const newOrderCount = document.getElementById("newOrderCount");

// Stats elements
const totalOrdersEl = document.getElementById("totalOrders");
const pendingOrdersEl = document.getElementById("pendingOrders");
const deliveredOrdersEl = document.getElementById("deliveredOrders");
const todayOrdersEl = document.getElementById("todayOrders");

// Variables
let unsub = null;
let allOrders = [];
let currentFilter = 'ALL';
let soundEnabled = true;
let audioContext = null;
let oscillator = null;
let gainNode = null;
let isPlayingSound = false;
let newOrderQueue = [];
let currentOrderId = null;
let previousOrderCount = 0;

const ALLOWED_EMAILS = ["natrajanraj1997@gmail.com"];

// --- AUDIO LOGIC ---
function initAudio() {
  try {
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  } catch (e) {
    soundEnabled = false;
    soundToggleBtn.classList.add('muted');
  }
}

function playNotificationSound() {
  if (!soundEnabled || !audioContext || isPlayingSound) return;
  try {
    oscillator = audioContext.createOscillator();
    gainNode = audioContext.createGain();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.5);
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.start();
    isPlayingSound = true;
    let time = audioContext.currentTime;
    for (let i = 0; i < 20; i++) {
      oscillator.frequency.setValueAtTime(800 + (i % 2) * 200, time + i * 1);
    }
  } catch (e) {}
}

function stopNotificationSound() {
  if (!isPlayingSound || !oscillator) return;
  try {
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
    oscillator.stop(audioContext.currentTime + 0.5);
    isPlayingSound = false;
    oscillator = null;
    gainNode = null;
  } catch (e) {}
}

soundToggleBtn.onclick = () => {
  soundEnabled = !soundEnabled;
  if (soundEnabled) {
    soundToggleBtn.classList.remove('muted');
    initAudio();
    showToast("üîî Sound notifications enabled");
  } else {
    soundToggleBtn.classList.add('muted');
    stopNotificationSound();
    showToast("üîï Sound notifications muted");
  }
  localStorage.setItem('soundEnabled', soundEnabled);
};

// --- NOTIFICATION LOGIC ---
function showNewOrderNotification(order) {
  currentOrderId = order.id;
  newOrderQueue.push(order);
  updateNewOrderCounter();
  
  if (soundEnabled) {
    playNotificationSound();
  }
  
  // Show the banner
  newOrderCounter.style.display = 'flex';
}

function updateNewOrderCounter() {
  const newOrders = allOrders.filter(order => order.status === 'NEW');
  newOrderCount.textContent = newOrders.length;
  if (newOrders.length > 0) newOrderCounter.style.display = 'flex';
  else newOrderCounter.style.display = 'none';
}

// Click on banner stops sound
newOrderCounter.onclick = () => {
  stopNotificationSound();
  newOrderCounter.style.display = 'none';
  if (currentOrderId) {
    const el = document.getElementById(`order-${currentOrderId}`);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    filterOrders('NEW');
  }
  currentOrderId = null;
};

window.toggleCodePanel = () => {
  const panel = document.getElementById("codePanel");
  panel.style.display = panel.style.display === "block" ? "none" : "block";
};

function showToast(msg) {
  statusFeedback.innerText = msg;
  statusFeedback.style.display = 'block';
  setTimeout(() => statusFeedback.style.display = 'none', 3000);
}

// --- MAIN LOGIC ---
window.filterOrders = (filter) => {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  renderOrders();
};

function updateStats() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const todayOrders = allOrders.filter(order => {
    const d = order.createdAt?.toDate ? order.createdAt.toDate() : new Date();
    return d >= today;
  });
  
  const pending = allOrders.filter(o => o.status === 'NEW' || o.status === 'INPROGRESS');
  const delivered = allOrders.filter(o => o.status === 'DELIVERED');
  
  totalOrdersEl.textContent = allOrders.length;
  pendingOrdersEl.textContent = pending.length;
  deliveredOrdersEl.textContent = delivered.length;
  todayOrdersEl.textContent = todayOrders.length;
  
  // Detect new order
  const currentNewOrders = allOrders.filter(order => order.status === 'NEW');
  if (currentNewOrders.length > previousOrderCount) {
    const newOrder = currentNewOrders[0];
    showNewOrderNotification(newOrder);
  }
  previousOrderCount = currentNewOrders.length;
  updateNewOrderCounter();
}

function renderOrders() {
  const filteredOrders = currentFilter === 'ALL' 
    ? allOrders 
    : allOrders.filter(o => o.status === currentFilter);
  
  if (filteredOrders.length === 0) {
    ordersList.innerHTML = `
      <div class="empty-state">
        <span class="empty-icon">üì≠</span>
        <h3>No orders found</h3>
        <p>There are no orders in this category.</p>
      </div>`;
    return;
  }
  
  let html = '';
  
  filteredOrders.forEach((order) => {
    const items = order.items || {};
    let itemsHtml = '';
    let subtotal = 0;

    for (let key in items){
      const it = items[key];
      const itemName = it.name || key;
      const itemTotal = it.qty * (it.price || 0);
      subtotal += itemTotal;
      
      itemsHtml += `
        <li class="order-item">
          <div><span class="item-qty">${it.qty}x</span> <span class="item-name">${itemName}</span></div>
          <div class="item-price">‚Çπ${itemTotal}</div>
        </li>`;
    }

    const deliveryFee = order.deliveryFee !== undefined ? order.deliveryFee : (subtotal >= 200 ? 0 : 40);
    const grandTotal = order.total !== undefined ? order.total : (subtotal + deliveryFee);
    
    const created = order.createdAt?.toDate ? order.createdAt.toDate() : new Date();
    const dateStr = created.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
    const timeStr = created.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    
    const status = order.status || "NEW";
    const statusClass = status.toLowerCase();

    // Map Link
    const mapLink = order.location ? 
      `<a href="https://www.google.com/maps/search/?api=1&query=${order.location.lat},${order.location.lng}" target="_blank" class="location-box">
         üìç View Location on Map
       </a>` : '';

    html += `
      <div class="order-card" id="order-${order.id}">
        <div class="card-header-strip">
          <div class="order-id">#${order.id.substring(0,8)}</div>
          <div class="order-meta">
            <span class="order-date">${dateStr}, ${timeStr}</span>
            <span class="status-badge ${statusClass}">${status}</span>
          </div>
        </div>

        <div class="card-body">
          <div class="customer-info">
            <h4>Customer Details</h4>
            <div class="info-row">
              <span class="info-icon">üë§</span>
              <div>
                <div class="info-text">${order.name || 'Unknown'}</div>
              </div>
            </div>
            <div class="info-row">
              <span class="info-icon">üìû</span>
              <a href="tel:${order.mobile}" class="info-text" style="text-decoration:none; color:inherit;">${order.mobile || '--'}</a>
            </div>
            <div class="info-row">
              <span class="info-icon">üè†</span>
              <div class="info-text sub">${order.address || 'No address'}</div>
            </div>
            ${mapLink}
          </div>

          <div class="order-details-box">
            <ul class="order-item-list">${itemsHtml}</ul>
            <div class="order-total-row">
              <span class="total-label">Total Amount</span>
              <span class="total-amount">‚Çπ${grandTotal}</span>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button class="action-btn btn-new" onclick="setStatus('${order.id}','NEW', this)">Mark New</button>
          <button class="action-btn btn-prog" onclick="setStatus('${order.id}','INPROGRESS', this)">Processing</button>
          <button class="action-btn btn-done" onclick="setStatus('${order.id}','DELIVERED', this)">‚úÖ Complete</button>
          <button class="action-btn btn-cancel" onclick="setStatus('${order.id}','CANCELLED', this)">Cancel</button>
        </div>
      </div>
    `;
  });
  
  ordersList.innerHTML = html;
}

// --- AUTH & SETUP ---
onAuthStateChanged(auth, (user) => {
  if (user && ALLOWED_EMAILS.includes(user.email)) {
    showAdmin();
  } else {
    hideAdmin();
  }
});

googleBtn.onclick = async () => {
  try { await signInWithPopup(auth, provider); } 
  catch (err) { alert("Login failed"); }
};

logoutBtn.onclick = async () => {
  stopNotificationSound();
  await signOut(auth);
};

function showAdmin(){
  loginBox.style.display = "none";
  adminContent.style.display = "block";
  const savedSound = localStorage.getItem('soundEnabled');
  if (savedSound !== null) soundEnabled = savedSound === 'true';
  soundToggleBtn.classList.toggle('muted', !soundEnabled);
  initAudio();
  subscribeOrders();
}

function hideAdmin(){
  loginBox.style.display = "block";
  adminContent.style.display = "none";
  stopNotificationSound();
  newOrderCounter.style.display = 'none';
  if (unsub) { unsub(); unsub = null; }
}

// --- ACTIONS ---
window.setStatus = async (id, status, btn) => {
  const origText = btn.innerText;
  btn.innerText = "...";
  try {
    await updateDoc(doc(db, "orders", id), { status: status });
    
    if (status !== 'NEW') {
      newOrderQueue = newOrderQueue.filter(o => o.id !== id);
      stopNotificationSound();
      updateNewOrderCounter();
    }
    showToast(`Status updated to ${status}`);
  } catch (e) {
    alert("Update failed");
  } finally {
    btn.innerText = origText;
  }
};

function subscribeOrders(){
  if (unsub) return;
  const q = query(collection(db, "orders"), orderBy("createdAt","desc"));
  unsub = onSnapshot(q, (snapshot) => {
    const oldOrders = [...allOrders];
    allOrders = [];
    snapshot.forEach(d => allOrders.push({ id: d.id, ...d.data() }));
    
    // Check for new vs old logic
    if (oldOrders.length > 0) {
       const newOnes = allOrders.filter(n => n.status === 'NEW' && !oldOrders.some(o => o.id === n.id));
       if (newOnes.length > 0) newOnes.forEach(o => showNewOrderNotification(o));
    }
    
    updateStats();
    renderOrders();
  });
}
</script>
</body>
</html>