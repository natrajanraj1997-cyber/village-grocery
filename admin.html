<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Village Grocery</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6f8;
  margin:0;
}
header{
  background:#2e7d32;color:#fff;
  padding:14px 16px;
}
.container{max-width:800px;margin:20px auto;padding:12px}
.card{
  background:#fff;padding:16px;border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
  margin-bottom:12px;
}
.small{font-size:12px;color:#555}

/* login */
#loginBox{
  max-width:320px;margin:80px auto;text-align:center;
}
#loginBox button{
  width:100%;padding:10px;margin-top:8px;
  border:none;border-radius:20px;
  background:#fff;color:#444;cursor:pointer;
  border:1px solid #ccc;display:flex;
  align-items:center;justify-content:center;
}
#loginBox img{height:18px;margin-right:8px}

/* admin content */
#adminContent{display:none;}
.order-header{
  display:flex;justify-content:space-between;align-items:center;
}
.order-items{margin-top:6px;padding-left:18px;}
.badge{
  display:inline-block;padding:2px 8px;border-radius:10px;
  font-size:11px;background:#eee;
}
.badge.new{background:#ffd54f;}
</style>
</head>
<body>

<header>
  <div>Village Grocery ‚Äì Admin</div>
</header>

<!-- Google login -->
<div id="loginBox" class="card">
  <h3>Admin Login</h3>
  <button id="googleBtn">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
    <span>Sign in with Google</span>
  </button>
  <p class="small">Only your Google account will see orders. Others cannot access.</p>
</div>

<!-- admin content: orders list -->
<div id="adminContent" class="container">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Orders</h3>
      <button id="logoutBtn" style="padding:6px 10px;border-radius:20px;border:1px solid #ccc;background:#fff;cursor:pointer;">
        Logout
      </button>
    </div>
    <div id="ordersList">Loading orders‚Ä¶</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, onSnapshot, orderBy, query 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged,
  GoogleAuthProvider,
  signInWithPopup,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// SAME CONFIG AS CUSTOMER PAGE
const firebaseConfig = {
  apiKey: "AIzaSyCYDLsQLFvuTV1N0mXtZFVYcSQqOkGfCrE",
  authDomain: "grocery-orders-3ce26.firebaseapp.com",
  projectId: "grocery-orders-3ce26",
  storageBucket: "grocery-orders-3ce26.appspot.com",
  messagingSenderId: "786501136156",
  appId: "1:786501136156:web:9277a2f7ef937deff1d4d9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const loginBox = document.getElementById("loginBox");
const adminContent = document.getElementById("adminContent");
const ordersList = document.getElementById("ordersList");
const googleBtn = document.getElementById("googleBtn");
const logoutBtn = document.getElementById("logoutBtn");

let unsub = null;

// Only allow specific admin email(s)
const ALLOWED_EMAILS = [
  "natrajanraj1997@gmail.com"
];

// auth state listener
onAuthStateChanged(auth, (user) => {
  console.log("Auth state changed. User:", user?.email);
  console.log("Allowed list:", ALLOWED_EMAILS);

  if (user && ALLOWED_EMAILS.includes(user.email)) {
    console.log("Admin signed in:", user.email);
    showAdmin();
  } else {
    console.log("Not allowed or signed out");
    hideAdmin();
  }
});

// sign in with Google popup
googleBtn.onclick = async () => {
  try {
    await signInWithPopup(auth, provider);
  } catch (err) {
    console.error("Google sign-in error:", err);
    alert("Google sign-in failed");
  }
};

// logout
logoutBtn.onclick = async () => {
  await signOut(auth);
};

function showAdmin(){
  loginBox.style.display = "none";
  adminContent.style.display = "block";
  subscribeOrders();
}

function hideAdmin(){
  loginBox.style.display = "block";
  adminContent.style.display = "none";
  if (unsub) { unsub(); unsub = null; }
  ordersList.innerHTML = "Please sign in with Google.";
}

// subscribe to orders
function subscribeOrders(){
  if (unsub) return; // already listening
  const ordersRef = collection(db, "orders");
  const q = query(ordersRef, orderBy("createdAt","desc"));
  unsub = onSnapshot(q, (snapshot) => {
    console.log("Orders docs count:", snapshot.size);

    if (snapshot.empty) {
      ordersList.innerHTML = "<p>No orders yet.</p>";
      return;
    }
    let html = "";
    snapshot.forEach(doc => {
      const o = doc.data();
      const items = o.items || {};
      let itemsHtml = "";
      for (let id in items){
        const it = items[id];
        // item name from nested object, fallback to id
        const itemName = it.name || id;
        itemsHtml += `<li>${itemName} √ó ${it.qty} (‚Çπ${it.price})</li>`;
      }
      const created = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleString() : "";
      html += `
        <div class="card">
          <div class="order-header">
            <div>
              <b>${o.name}</b> ‚Äì ${o.mobile}<br>
              <span class="small">${o.address}</span><br>
              ${o.location ? `<span class="small">üìç ${o.location.lat.toFixed(5)}, ${o.location.lng.toFixed(5)}</span>` : ""}
            </div>
            <div>
              <span class="badge new">${o.status || "NEW"}</span><br>
              <span class="small">${created}</span>
            </div>
          </div>
          <ul class="order-items">
            ${itemsHtml}
          </ul>
        </div>
      `;
    });
    ordersList.innerHTML = html;
  }, (err) => {
    console.error("Orders onSnapshot error:", err);
    ordersList.innerHTML = "<p>Error loading orders (see console).</p>";
  });
}
</script>
</body>
</html>
