<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Village Grocery Delivery</title>

<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6f8;
  margin:0;padding-bottom:90px;
}
header{
  background:#2e7d32;color:#fff;
  padding:14px 16px;
  display:flex;justify-content:space-between;
}
.container{max-width:480px;margin:auto;padding:12px}

.search, .cats{
  background:#fff;padding:10px;
  margin-bottom:10px;border-radius:10px;
}

.search input{
  width:100%;padding:8px;border-radius:6px;
  border:1px solid #ccc;
}

.cats button{
  padding:6px 14px;border-radius:20px;
  border:1px solid #ccc;background:#fff;
  margin:4px;cursor:pointer;
}
.cats .active{background:#2e7d32;color:#fff}

.product{
  background:#fff;display:flex;align-items:center;
  padding:10px;margin-bottom:10px;
  border-radius:12px;
}
.product img{
  width:64px;height:64px;border-radius:10px;
  margin-right:10px;object-fit:cover;
}
.product h4{margin:0;font-size:15px}
.product p{margin:4px 0;color:#2e7d32;font-weight:bold}

.qty{
  margin-left:auto;text-align:right;
}
.add, .qty button{
  padding:6px 12px;border-radius:20px;
  border:1px solid #ccc;background:#fff;
  cursor:pointer;
}
.qty{display:none}
.qty span{margin:0 8px}
.out{
  color:red;font-size:12px;font-weight:bold;
}

.cart{
  background:#fff;padding:10px;border-radius:10px;
}
.cart ul{padding-left:18px}

.cart-bar{
  position:fixed;bottom:0;width:100%;
  background:#fff;padding:10px;
  box-shadow:0 -3px 10px rgba(0,0,0,.2);
}
.cart-bar button{
  width:100%;padding:12px;
  border:none;border-radius:30px;
  background:#2e7d32;color:#fff;font-size:16px;
}
.cart input, .cart textarea, .cart select{
  width:100%;
  box-sizing:border-box;
  padding:8px;
  margin:4px 0;
  border-radius:6px;
  border:1px solid #ccc;
}
.cart textarea{
  min-height:60px;
  resize:vertical;
}
#locStatus{
  font-size:12px;
  color:#555;
  margin-top:4px;
}
</style>
</head>

<body>

<header>
  <div>Village Grocery</div>
  <div>üõí <span id="count">0</span></div>
</header>

<div class="container">

<div class="search">
  <input id="search" placeholder="Search products">
</div>

<div class="cats">
  <button class="active" onclick="setCat('All')">All</button>
  <button onclick="setCat('Grocery')">Grocery</button>
  <button onclick="setCat('Bathroom')">Bathroom</button>
</div>

<div id="products"></div>

<div class="cart">
  <h4>üõí Cart</h4>
  <ul id="cartList"></ul>
  <b>Total ‚Çπ<span id="total">0</span></b>
</div>

<div class="cart">
  <h4>üì¶ Delivery</h4>
  <input id="name" placeholder="Name *">
  <input id="mobile" placeholder="Mobile *">

  <!-- Share live location -->
  <button type="button" onclick="getLocation()">üìç Share live location</button>
  <div id="locStatus"></div>

  <textarea id="address" placeholder="Address * (house / street / landmark)"></textarea>
</div>

</div>

<div class="cart-bar">
  <button onclick="placeOrder()">Place Order</button>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, addDoc, serverTimestamp, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCYDLsQLFvuTV1N0mXtZFVYcSQqOkGfCrE",
  authDomain: "grocery-orders-3ce26.firebaseapp.com",
  projectId: "grocery-orders-3ce26",
  storageBucket: "grocery-orders-3ce26.appspot.com",
  messagingSenderId: "786501136156",
  appId: "1:786501136156:web:9277a2f7ef937deff1d4d9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// PRODUCTS FROM FIRESTORE
let data = [];           // products
let cart = {};
let cat = 'All';

const list = document.getElementById("products");
const search = document.getElementById("search");
const cartList = document.getElementById("cartList");
const total = document.getElementById("total");
const count = document.getElementById("count");
const nameEl = document.getElementById("name");
const mobileEl = document.getElementById("mobile");
const addressEl = document.getElementById("address");
const locStatus = document.getElementById("locStatus");

// geolocation variables
let currentLat = null;
let currentLng = null;

// realtime listener on "products" collection
const productsRef = collection(db, "products");
onSnapshot(productsRef, (snapshot) => {
  data = snapshot.docs.map(doc => {
    const d = doc.data();
    return {
      id: doc.id,          // e.g. "rice"
      name: d.Name,        // Firestore: Name (string)
      price: d.price,      // Firestore: price (number)
      cat: d.cat || "Grocery", // Firestore: cat (string)
      img: d.img,          // Firestore: img (string URL)
      inStock: d.stock,    // Firestore: stock (boolean)
      unit: d.unit         // Firestore: unit (string)
    };
  });
  render();
});

function render(){
  list.innerHTML = '';
  const txt = search.value.toLowerCase();
  data
    .filter(p =>
      p.name.toLowerCase().includes(txt) &&
      (cat === 'All' || p.cat === cat)
    )
    .forEach(p => {
      list.innerHTML += `
      <div class="product">
        <img src="${p.img}">
        <div>
          <h4>${p.name} ${p.unit ? '('+p.unit+')' : ''}</h4>
          <p>‚Çπ${p.price}</p>
          ${p.inStock ? '' : '<div class="out">OUT OF STOCK</div>'}
        </div>
        <div class="qty">
          <button onclick="chg('${p.id}',-1)">‚àí</button>
          <span>${cart[p.id]?.qty || 0}</span>
          <button onclick="chg('${p.id}',1)">+</button>
        </div>
        ${p.inStock ? `<button class="add" onclick="add('${p.id}')">Add</button>` : ''}
      </div>`;
    });
}

window.setCat = c => {
  cat = c;
  document.querySelectorAll('.cats button')
    .forEach(b => b.classList.toggle('active', b.textContent === c));
  render();
};

window.add = id => {
  const product = data.find(p => p.id === id);
  if (!product) return;
  if (!cart[id]) {
    cart[id] = { qty: 1, price: product.price, name: product.name };
  } else {
    cart[id].qty += 1;
  }
  renderCart();
  render();
};

window.chg = (id, d) => {
  if (!cart[id]) return;
  cart[id].qty += d;
  if (cart[id].qty <= 0) delete cart[id];
  renderCart();
  render();
};

function renderCart(){
  cartList.innerHTML=''; 
  let t = 0, c = 0;
  for(let i in cart){
    t += cart[i].qty * cart[i].price;
    c += cart[i].qty;
    cartList.innerHTML += `<li>${cart[i].name} √ó ${cart[i].qty}</li>`;
  }
  total.textContent = t;
  count.textContent = c;
}

// get current location
window.getLocation = () => {
  if (!navigator.geolocation) {
    locStatus.textContent = "Geolocation not supported in this browser.";
    return;
  }
  locStatus.textContent = "Getting location...";
  navigator.geolocation.getCurrentPosition(
    (position) => {
      currentLat = position.coords.latitude;
      currentLng = position.coords.longitude;
      locStatus.textContent = `Location captured ‚úÖ (${currentLat.toFixed(5)}, ${currentLng.toFixed(5)})`;
    },
    (error) => {
      locStatus.textContent = "Unable to get location. Please allow location permission.";
      console.warn(error);
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
};

window.placeOrder = async () => {
  if(!nameEl.value || !mobileEl.value || !addressEl.value || !Object.keys(cart).length){
    alert("Fill all details");
    return;
  }

  await addDoc(collection(db,"orders"),{
    name: nameEl.value,
    mobile: mobileEl.value,
    address: addressEl.value,
    items: cart,
    status:"NEW",
    createdAt: serverTimestamp(),
    location: (currentLat !== null && currentLng !== null) ? {
      lat: currentLat,
      lng: currentLng
    } : null
  });

  alert("‚úÖ Order placed");
  cart = {};
  renderCart();
  render();
  nameEl.value = '';
  mobileEl.value = '';
  addressEl.value = '';
  locStatus.textContent = '';
  currentLat = null;
  currentLng = null;
};

search.oninput = render;
</script>

</body>
</html>
