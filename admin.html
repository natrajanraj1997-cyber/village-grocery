<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Village Grocery</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* =========================================
   MODERN DASHBOARD VARIABLES
   ========================================= */
:root {
  --primary: #059669;       /* Modern Emerald Green */
  --primary-dark: #047857;
  --bg-body: #f3f4f6;       /* Light Cool Gray */
  --bg-card: #ffffff;
  --text-main: #111827;     /* Deep Black/Blue */
  --text-sub: #6b7280;      /* Cool Gray */
  --border: #e5e7eb;
  
  /* Status Colors */
  --status-new-bg: #fee2e2; --status-new-text: #ef4444;
  --status-prog-bg: #dbeafe; --status-prog-text: #3b82f6;
  --status-done-bg: #d1fae5; --status-done-text: #059669;
  --status-cancel-bg: #f3f4f6; --status-cancel-text: #9ca3af;

  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --radius: 12px;
  --radius-lg: 16px;
  --transition: all 0.2s ease-in-out;
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

body {
  font-family: 'Poppins', sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* =========================================
   HEADER & NAV
   ========================================= */
header {
  background: var(--bg-card);
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 50;
  box-shadow: var(--shadow-sm);
  border-bottom: 1px solid var(--border);
}

.brand { font-weight: 700; font-size: 1.25rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
.brand span { color: var(--text-main); }

/* Hidden by default, shown via JS */
.nav-controls { display: none; gap: 12px; align-items: center; } 

/* Navigation Tabs (Orders vs Products) */
.nav-tab-group { background: #e5e7eb; padding: 4px; border-radius: 8px; display: flex; gap: 4px; }
.nav-tab {
  padding: 6px 16px; border: none; border-radius: 6px; font-weight: 600; font-size: 0.9rem; cursor: pointer; color: var(--text-sub); transition: var(--transition);
}
.nav-tab.active { background: white; color: var(--text-main); box-shadow: var(--shadow-sm); }

#soundToggleBtn {
  background: var(--bg-body); border: 1px solid var(--border); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: var(--transition);
}
#soundToggleBtn.muted::after { content: "üîï"; opacity: 0.6; }
#soundToggleBtn:not(.muted)::after { content: "üîî"; }

/* =========================================
   LOGIN SCREEN
   ========================================= */
#loginBox {
  max-width: 400px; margin: 100px auto 20px; background: var(--bg-card); padding: 40px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); text-align: center; border: 1px solid var(--border);
}
#googleBtn {
  width: 100%; padding: 12px; background: #fff; border: 1px solid var(--border); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; gap: 12px; font-weight: 600; color: var(--text-main); cursor: pointer; transition: var(--transition);
}
#googleBtn img { width: 20px; }

/* =========================================
   ADMIN DASHBOARD CONTENT
   ========================================= */
#adminContent { display: none; padding: 24px; max-width: 1200px; margin: 0 auto; }

/* Views Logic */
.view-section { display: none; }
.view-section.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

/* STATS GRID */
.stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 32px; }
.stat-card {
  background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; align-items: flex-start;
}
.stat-label { font-size: 0.85rem; font-weight: 500; color: var(--text-sub); }
.stat-value { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
.stat-card:nth-child(1) .stat-value { color: var(--primary); }

/* FILTERS & SEARCH */
.filter-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
#searchInput, #productSearchInput {
  padding: 10px 16px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; width: 280px; background-color: white;
}
.filter-tabs { background: #e5e7eb; padding: 4px; border-radius: var(--radius); display: inline-flex; gap: 4px; flex-wrap: wrap; }
.filter-btn { padding: 8px 16px; border-radius: 8px; border: none; background: transparent; color: var(--text-sub); font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: var(--transition); }
.filter-btn.active { background: white; color: var(--primary); box-shadow: var(--shadow-sm); }

/* =========================================
   ORDER CARDS
   ========================================= */
#ordersList { display: flex; flex-direction: column; gap: 20px; }
.order-card {
  background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border); box-shadow: var(--shadow-sm); overflow: hidden;
}
.card-header-strip { padding: 16px 24px; background: #f9fafb; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
.order-id { font-family: monospace; font-weight: 600; color: var(--text-sub); font-size: 0.9rem; }
.order-meta { display: flex; gap: 12px; align-items: center; }
.status-badge { padding: 4px 12px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.status-badge.new { background: var(--status-new-bg); color: var(--status-new-text); }
.status-badge.inprogress { background: var(--status-prog-bg); color: var(--status-prog-text); }
.status-badge.delivered { background: var(--status-done-bg); color: var(--status-done-text); }
.status-badge.cancelled { background: var(--status-cancel-bg); color: var(--status-cancel-text); }

.card-body { padding: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
@media(max-width: 768px) { .card-body { grid-template-columns: 1fr; } }

.info-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; font-size: 0.95rem; }
.location-box { margin-top: 12px; background: #ecfdf5; padding: 8px 12px; border-radius: 8px; color: var(--primary-dark); font-size: 0.85rem; display: flex; align-items: center; gap: 8px; border: 1px solid #d1fae5; text-decoration: none; }

.order-details-box { background: #f9fafb; border-radius: var(--radius); padding: 16px; border: 1px solid var(--border); }
.order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border); font-size: 0.9rem; }
.order-total-row { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 2px solid var(--border); font-size: 1.1rem; font-weight: 700; color: var(--primary); }

.card-footer { padding: 16px 24px; border-top: 1px solid var(--border); background: #fff; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
.action-btn { padding: 10px 20px; border-radius: 8px; border: 1px solid transparent; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: var(--transition); }
.btn-new { background: white; border-color: var(--status-new-text); color: var(--status-new-text); }
.btn-prog { background: white; border-color: var(--status-prog-text); color: var(--status-prog-text); }
.btn-done { background: var(--primary); color: white; }
.btn-cancel { background: transparent; color: var(--text-sub); }
.btn-print { background: #64748b; color: white; }

/* =========================================
   PRODUCT MANAGEMENT STYLES
   ========================================= */
#productList { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

.product-card {
  background: white; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; padding: 16px; display: flex; align-items: center; gap: 16px; transition: var(--transition);
}
.product-card:hover { border-color: var(--primary); box-shadow: var(--shadow-sm); }

.prod-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; background: #f3f4f6; }
.prod-info { flex: 1; }
.prod-name { font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 4px; }
.prod-price { color: var(--text-sub); font-size: 0.9rem; }

/* IOS Toggle Switch */
.switch { position: relative; display: inline-block; width: 48px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--primary); }
input:checked + .slider:before { transform: translateX(22px); }

/* =========================================
   NOTIFICATIONS
   ========================================= */
.status-toast { position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 12px 24px; border-radius: 50px; z-index: 1000; display: none; animation: slideIn 0.3s ease; }
@keyframes slideIn { from{transform:translateX(100%);} to{transform:translateX(0);} }

.new-order-alert { position: fixed; top: 24px; left: 50%; transform: translateX(-50%); background: #111827; color: #fff; padding: 12px 24px; border-radius: 99px; display: none; align-items: center; gap: 12px; z-index: 2000; cursor: pointer; }
.alert-badge { background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 700; }

.empty-state { text-align: center; padding: 80px 20px; color: var(--text-sub); }
.empty-icon { font-size: 3rem; margin-bottom: 16px; display: block; opacity: 0.5; }

/* Code Panel (Hidden) */
.code-panel { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; }
.code-content { position: absolute; right: 0; top: 0; bottom: 0; width: 500px; background: #1e1e1e; padding: 20px; overflow: auto; color: #ccc; }
.code-toggle { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; opacity: 0.5; }

/* Responsive */
@media (max-width: 600px) {
  header { flex-direction: column; align-items: flex-start; gap: 10px; }
  .nav-controls { width: 100%; justify-content: space-between; }
  .filter-bar { flex-direction: column; align-items: stretch; }
  #searchInput, #productSearchInput { width: 100%; margin-bottom: 10px; }
  .card-footer { justify-content: stretch; }
  .action-btn { flex: 1; justify-content: center; }
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <span>üë®‚Äçüíº</span> Village Grocery
  </div>
  
  <div class="nav-controls" id="navControls">
    <div class="nav-tab-group">
      <button class="nav-tab active" onclick="switchView('orders')">Orders</button>
      <button class="nav-tab" onclick="switchView('products')">Products</button>
    </div>
    <button id="soundToggleBtn" title="Toggle Sound Notifications"></button>
    <button onclick="logoutAdmin()" style="font-size:0.8rem; background:none; border:none; color:var(--text-sub); cursor:pointer;">Logout</button>
  </div>
</header>

<div id="statusFeedback" class="status-toast">
  ‚úÖ Update Successful
</div>

<div id="newOrderCounter" class="new-order-alert">
  <span>üîî New Order Received!</span>
  <span class="alert-badge" id="newOrderCount">1</span>
</div>

<div id="loginBox">
  <h3>Welcome Back</h3>
  <p>Please sign in to access the dashboard.</p>
  <button id="googleBtn">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
    <span>Sign in with Google</span>
  </button>
</div>

<div id="adminContent">

  <div id="ordersView" class="view-section active">
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Total Orders</div>
        <div class="stat-value" id="totalOrders">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-value" id="pendingOrders">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Delivered</div>
        <div class="stat-value" id="deliveredOrders">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Today</div>
        <div class="stat-value" id="todayOrders">0</div>
      </div>
    </div>

    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="üîç Search Name, Phone, or ID..." onkeyup="filterOrders(currentFilter)"> 
      <div class="filter-tabs">
        <button class="filter-btn active" onclick="filterOrders('ALL')">All</button>
        <button class="filter-btn" onclick="filterOrders('NEW')">New</button>
        <button class="filter-btn" onclick="filterOrders('INPROGRESS')">Processing</button>
        <button class="filter-btn" onclick="filterOrders('DELIVERED')">Completed</button>
      </div>
    </div>

    <div id="ordersList" class="loading">Loading orders...</div>
  </div>

  <div id="productsView" class="view-section">
    <div class="filter-bar">
      <input type="text" id="productSearchInput" placeholder="üîç Search Products..." onkeyup="renderProducts()"> 
      <div style="font-size:0.9rem; color:var(--text-sub); margin-left:auto;">
        Toggle switch to turn stock ON/OFF
      </div>
    </div>
    <div id="productList">Loading products...</div>
  </div>

</div>

<div id="codePanel" class="code-panel">
  <div class="code-content">
    <h3>Code Viewer</h3>
    <button onclick="toggleCodePanel()">Close</button>
    <pre><code>// Config is secure</code></pre>
  </div>
</div>
<button class="code-toggle" onclick="toggleCodePanel()">üíª</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, onSnapshot, orderBy, query, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged,
  GoogleAuthProvider,
  signInWithPopup,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyCYDLsQLFvuTV1N0mXtZFVYcSQqOkGfCrE",
  authDomain: "grocery-orders-3ce26.firebaseapp.com",
  projectId: "grocery-orders-3ce26",
  storageBucket: "grocery-orders-3ce26.appspot.com",
  messagingSenderId: "786501136156",
  appId: "1:786501136156:web:9277a2f7ef937deff1d4d9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// DOM Elements
const loginBox = document.getElementById("loginBox");
const adminContent = document.getElementById("adminContent");
const ordersList = document.getElementById("ordersList");
const productList = document.getElementById("productList");
const googleBtn = document.getElementById("googleBtn");
const statusFeedback = document.getElementById("statusFeedback");
const soundToggleBtn = document.getElementById("soundToggleBtn");
const newOrderCounter = document.getElementById("newOrderCounter");
const newOrderCount = document.getElementById("newOrderCount");
const navControls = document.getElementById("navControls"); // --- NEW ---

// Stats elements
const totalOrdersEl = document.getElementById("totalOrders");
const pendingOrdersEl = document.getElementById("pendingOrders");
const deliveredOrdersEl = document.getElementById("deliveredOrders");
const todayOrdersEl = document.getElementById("todayOrders");

// Variables
let unsubOrders = null;
let unsubProducts = null;
let allOrders = [];
let allProducts = [];
let currentFilter = 'ALL';
let soundEnabled = true;
let audioContext = null;
let oscillator = null;
let gainNode = null;
let isPlayingSound = false;
let newOrderQueue = [];
let currentOrderId = null;
let previousOrderCount = 0;

const ALLOWED_EMAILS = ["natrajanraj1997@gmail.com"];

// --- VIEW NAVIGATION ---
window.switchView = (viewName) => {
  document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
  
  document.getElementById(viewName + 'View').classList.add('active');
  // Highlight active tab logic roughly
  if(viewName === 'orders') document.querySelector('.nav-tab:nth-child(1)').classList.add('active');
  else document.querySelector('.nav-tab:nth-child(2)').classList.add('active');
};

// --- AUDIO LOGIC ---
function initAudio() {
  try {
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  } catch (e) {
    soundEnabled = false;
    soundToggleBtn.classList.add('muted');
  }
}

function playNotificationSound() {
  if (!soundEnabled || !audioContext || isPlayingSound) return;
  try {
    oscillator = audioContext.createOscillator();
    gainNode = audioContext.createGain();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.5);
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.start();
    isPlayingSound = true;
    let time = audioContext.currentTime;
    for (let i = 0; i < 20; i++) {
      oscillator.frequency.setValueAtTime(800 + (i % 2) * 200, time + i * 1);
    }
  } catch (e) {}
}

function stopNotificationSound() {
  if (!isPlayingSound || !oscillator) return;
  try {
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
    oscillator.stop(audioContext.currentTime + 0.5);
    isPlayingSound = false;
    oscillator = null;
    gainNode = null;
  } catch (e) {}
}

soundToggleBtn.onclick = () => {
  soundEnabled = !soundEnabled;
  if (soundEnabled) {
    soundToggleBtn.classList.remove('muted');
    initAudio();
    showToast("üîî Sound Enabled");
  } else {
    soundToggleBtn.classList.add('muted');
    stopNotificationSound();
    showToast("üîï Sound Muted");
  }
  localStorage.setItem('soundEnabled', soundEnabled);
};

// --- NOTIFICATIONS ---
function showNewOrderNotification(order) {
  currentOrderId = order.id;
  newOrderQueue.push(order);
  updateNewOrderCounter();
  if (soundEnabled) playNotificationSound();
  newOrderCounter.style.display = 'flex';
}

function updateNewOrderCounter() {
  const newOrders = allOrders.filter(order => order.status === 'NEW');
  newOrderCount.textContent = newOrders.length;
  if (newOrders.length > 0) newOrderCounter.style.display = 'flex';
  else newOrderCounter.style.display = 'none';
}

newOrderCounter.onclick = () => {
  stopNotificationSound();
  newOrderCounter.style.display = 'none';
  if (currentOrderId) {
    const el = document.getElementById(`order-${currentOrderId}`);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    filterOrders('NEW');
  }
  currentOrderId = null;
};

window.toggleCodePanel = () => {
  const panel = document.getElementById("codePanel");
  panel.style.display = panel.style.display === "block" ? "none" : "block";
};

function showToast(msg) {
  statusFeedback.innerText = msg;
  statusFeedback.style.display = 'block';
  setTimeout(() => statusFeedback.style.display = 'none', 3000);
}

// --- AUTH & SETUP ---
onAuthStateChanged(auth, (user) => {
  if (user && ALLOWED_EMAILS.includes(user.email)) {
    showAdmin();
  } else {
    hideAdmin();
  }
});

googleBtn.onclick = async () => {
  try { await signInWithPopup(auth, provider); } 
  catch (err) { alert("Login failed"); }
};

window.logoutAdmin = async () => {
  stopNotificationSound();
  await signOut(auth);
};

function showAdmin(){
  loginBox.style.display = "none";
  adminContent.style.display = "block";
  navControls.style.display = "flex"; // --- SHOW MENU ---
  
  const savedSound = localStorage.getItem('soundEnabled');
  if (savedSound !== null) soundEnabled = savedSound === 'true';
  soundToggleBtn.classList.toggle('muted', !soundEnabled);
  initAudio();
  subscribeOrders();
  subscribeProducts(); // NEW: Load products
}

function hideAdmin(){
  loginBox.style.display = "block";
  adminContent.style.display = "none";
  navControls.style.display = "none"; // --- HIDE MENU ---
  
  stopNotificationSound();
  newOrderCounter.style.display = 'none';
  if (unsubOrders) { unsubOrders(); unsubOrders = null; }
  if (unsubProducts) { unsubProducts(); unsubProducts = null; }
}

// ==========================================
// ORDER MANAGEMENT
// ==========================================
window.setStatus = async (id, status, btn) => {
  const origText = btn.innerText;
  btn.innerText = "...";
  try {
    await updateDoc(doc(db, "orders", id), { status: status });
    if (status !== 'NEW') {
      newOrderQueue = newOrderQueue.filter(o => o.id !== id);
      stopNotificationSound();
      updateNewOrderCounter();
    }
    showToast(`Updated to ${status}`);
  } catch (e) {
    alert("Update failed");
  } finally {
    btn.innerText = origText;
  }
};

window.filterOrders = (filter) => {
  if (filter) currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.innerText.toUpperCase().includes(currentFilter === 'ALL' ? 'ALL' : currentFilter));
  });
  renderOrders();
};

function subscribeOrders(){
  if (unsubOrders) return;
  const q = query(collection(db, "orders"), orderBy("createdAt","desc"));
  unsubOrders = onSnapshot(q, (snapshot) => {
    const oldOrders = [...allOrders];
    allOrders = [];
    snapshot.forEach(d => allOrders.push({ id: d.id, ...d.data() }));
    
    // Check for new orders
    if (oldOrders.length > 0) {
       const newOnes = allOrders.filter(n => n.status === 'NEW' && !oldOrders.some(o => o.id === n.id));
       if (newOnes.length > 0) newOnes.forEach(o => showNewOrderNotification(o));
    }
    
    updateStats();
    renderOrders();
  });
}

function updateStats() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const todayOrders = allOrders.filter(order => {
    const d = order.createdAt?.toDate ? order.createdAt.toDate() : new Date();
    return d >= today;
  });
  
  const pending = allOrders.filter(o => o.status === 'NEW' || o.status === 'INPROGRESS');
  const delivered = allOrders.filter(o => o.status === 'DELIVERED');
  
  totalOrdersEl.textContent = allOrders.length;
  pendingOrdersEl.textContent = pending.length;
  deliveredOrdersEl.textContent = delivered.length;
  todayOrdersEl.textContent = todayOrders.length;
  
  const currentNewOrders = allOrders.filter(order => order.status === 'NEW');
  if (currentNewOrders.length > previousOrderCount) {
    showNewOrderNotification(currentNewOrders[0]);
  }
  previousOrderCount = currentNewOrders.length;
  updateNewOrderCounter();
}

function renderOrders() {
  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
  const filteredOrders = allOrders.filter(o => {
    const statusMatch = (currentFilter === 'ALL') || (o.status === currentFilter);
    const searchMatch = 
      (o.name && o.name.toLowerCase().includes(searchTerm)) ||
      (o.mobile && o.mobile.includes(searchTerm)) ||
      (o.id && o.id.toLowerCase().includes(searchTerm));
    return statusMatch && searchMatch;
  });
  
  if (filteredOrders.length === 0) {
    ordersList.innerHTML = `<div class="empty-state"><span class="empty-icon">üì≠</span><h3>No orders found</h3></div>`;
    return;
  }
  
  let html = '';
  filteredOrders.forEach((order) => {
    const items = order.items || {};
    let itemsHtml = '';
    let subtotal = 0;

    for (let key in items){
      const it = items[key];
      const itemName = it.name || key;
      const itemTotal = it.qty * (it.price || 0);
      subtotal += itemTotal;
      itemsHtml += `
        <li class="order-item">
          <div><span class="item-qty">${it.qty}x</span> <span class="item-name">${itemName}</span></div>
          <div class="item-price">‚Çπ${itemTotal}</div>
        </li>`;
    }

    const deliveryFee = order.deliveryFee !== undefined ? order.deliveryFee : (subtotal >= 200 ? 0 : 40);
    const grandTotal = order.total !== undefined ? order.total : (subtotal + deliveryFee);
    const created = order.createdAt?.toDate ? order.createdAt.toDate() : new Date();
    const dateStr = created.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
    const timeStr = created.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    const status = order.status || "NEW";
    const statusClass = status.toLowerCase();
    const mapLink = order.location ? 
      `<a href="https://maps.google.com/?q=${order.location.lat},${order.location.lng}" target="_blank" class="location-box">üìç View Location</a>` : '';

    html += `
      <div class="order-card" id="order-${order.id}">
        <div class="card-header-strip">
          <div class="order-id">#${order.id.substring(0,8)}</div>
          <div class="order-meta"><span class="order-date">${dateStr}, ${timeStr}</span><span class="status-badge ${statusClass}">${status}</span></div>
        </div>
        <div class="card-body">
          <div class="customer-info">
            <h4>Customer</h4>
            <div class="info-row">üë§ ${order.name || 'Unknown'}</div>
            <div class="info-row">üìû <a href="tel:${order.mobile}" style="text-decoration:none; color:inherit;">${order.mobile || '--'}</a></div>
            <div class="info-row">üè† ${order.address || 'No address'}</div>
            ${mapLink}
          </div>
          <div class="order-details-box">
            <ul class="order-item-list">${itemsHtml}</ul>
            <div class="order-total-row"><span>Total</span><span>‚Çπ${grandTotal}</span></div>
          </div>
        </div>
        <div class="card-footer">
          <button class="action-btn btn-new" onclick="setStatus('${order.id}','NEW', this)">Mark New</button>
          <button class="action-btn btn-prog" onclick="setStatus('${order.id}','INPROGRESS', this)">Processing</button>
          <button class="action-btn btn-done" onclick="setStatus('${order.id}','DELIVERED', this)">‚úÖ Complete</button>
          <button class="action-btn btn-cancel" onclick="setStatus('${order.id}','CANCELLED', this)">Cancel</button>
          <button class="action-btn btn-print" onclick="printOrder('${order.id}')">üñ®Ô∏è Print</button>
        </div>
      </div>
    `;
  });
  ordersList.innerHTML = html;
}

window.printOrder = (id) => {
  const order = allOrders.find(o => o.id === id);
  if (!order) return;
  const printWindow = window.open('', '', 'width=400,height=600');
  let itemsHtml = '';
  let subtotal = 0;
  if (order.items) {
    for (let key in order.items) {
      const i = order.items[key];
      const lineTotal = i.qty * i.price;
      subtotal += lineTotal;
      itemsHtml += `<tr><td style="padding:4px 0; border-bottom:1px solid #eee;">${i.name}</td><td style="text-align:center; border-bottom:1px solid #eee;">${i.qty}</td><td style="text-align:right; border-bottom:1px solid #eee;">‚Çπ${lineTotal}</td></tr>`;
    }
  }
  const delivery = order.deliveryFee || (subtotal >= 200 ? 0 : 40);
  const finalTotal = order.total || (subtotal + delivery);
  printWindow.document.write(`
    <html><head><title>Receipt #${id.substring(0,6)}</title><style>body{font-family:'Courier New',monospace;padding:20px;font-size:12px;color:#000;}h3{text-align:center;margin:0 0 10px 0;}.meta{text-align:center;margin-bottom:15px;font-size:10px;}table{width:100%;border-collapse:collapse;}th{text-align:left;border-bottom:1px dashed #000;padding:5px 0;}.total-row{font-weight:bold;font-size:14px;margin-top:10px;border-top:1px dashed #000;padding-top:5px;text-align:right;}.footer{margin-top:20px;text-align:center;font-size:10px;}</style></head>
    <body><h3>Village Grocery</h3><div class="meta">Date: ${new Date().toLocaleString()}<br>Order ID: #${id.substring(0,8)}</div><div style="margin-bottom:15px; border-bottom:1px solid #000; padding-bottom:10px;"><strong>${order.name}</strong><br>${order.mobile}<br>${order.address}</div><table><thead><tr><th>Item</th><th>Qty</th><th style="text-align:right;">Amt</th></tr></thead><tbody>${itemsHtml}</tbody></table><div style="text-align:right; margin-top:5px;">Delivery: ‚Çπ${delivery}</div><div class="total-row">TOTAL: ‚Çπ${finalTotal}</div><div class="footer">Thank you for shopping!</div></body></html>
  `);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
};

// ==========================================
// PRODUCT MANAGEMENT (NEW)
// ==========================================
function subscribeProducts() {
  if (unsubProducts) return;
  // ‚úÖ FIX: Changed back to "products" (lowercase)
  const q = collection(db, "products"); 
  unsubProducts = onSnapshot(q, (snapshot) => {
    allProducts = [];
    snapshot.forEach(d => allProducts.push({ id: d.id, ...d.data() }));
    renderProducts();
  });
}

window.renderProducts = () => {
  const searchTerm = document.getElementById("productSearchInput").value.toLowerCase();
  
  const filtered = allProducts.filter(p => 
    p.Name.toLowerCase().includes(searchTerm)
  );

  if (filtered.length === 0) {
    productList.innerHTML = `<div class="empty-state">No products found</div>`;
    return;
  }

  let html = '';
  filtered.forEach(p => {
    // Check stock status based on your schema
    const isActive = (p.stock !== false); 
    
    html += `
      <div class="product-card">
        <img src="${p.img || 'https://via.placeholder.com/60'}" class="prod-img">
        <div class="prod-info">
          <div class="prod-name">${p.Name}</div>
          <div class="prod-price">‚Çπ${p.price}</div>
        </div>
        <label class="switch">
          <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleStock('${p.id}', this.checked)">
          <span class="slider"></span>
        </label>
      </div>
    `;
  });
  productList.innerHTML = html;
};

window.toggleStock = async (id, isChecked) => {
  try {
    // ‚úÖ FIX: Changed back to "products" (lowercase)
    const productRef = doc(db, "products", id); 
    
    await updateDoc(productRef, { 
      stock: isChecked,
      astockcount: isChecked ? 50 : 0 
    });
    
    showToast(isChecked ? "Product Enabled" : "Product Disabled");
    
  } catch (e) {
    console.error("Firebase Error:", e);
    // This alert will help us if it fails again
    alert("‚ùå Error: " + e.code + " - " + e.message);
    renderProducts(); 
  }
};

</script>
</body>
</html>