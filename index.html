<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Village Grocery Delivery</title>

<style>
:root{
  --green:#2e7d32;
  --light:#f4f6f8;
  --card:#ffffff;
  --border:#e0e0e0;
}
*{box-sizing:border-box}
body{
  font-family:Arial,sans-serif;
  background:var(--light);
  margin:0;
  padding-bottom:90px;
}
header{
  background:var(--green);color:#fff;
  padding:14px 16px;
  display:flex;justify-content:space-between;align-items:center;
  position:sticky;top:0;z-index:10;
}
header div:first-child{font-weight:bold}

.container{max-width:480px;margin:auto;padding:12px}

/* cards */
.card{
  background:var(--card);
  border-radius:14px;
  padding:12px;
  margin-bottom:12px;
  box-shadow:0 1px 3px rgba(0,0,0,.06);
}

/* search & categories */
.search input{
  width:100%;padding:9px 10px;border-radius:8px;
  border:1px solid var(--border);font-size:14px;
}
.cats{
  display:flex;flex-wrap:wrap;gap:6px;
}
.cats button{
  padding:6px 14px;border-radius:20px;
  border:1px solid var(--border);background:#fff;
  cursor:pointer;font-size:13px;
}
.cats .active{background:var(--green);color:#fff;border-color:var(--green)}

/* product list */
.product{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 8px;border-radius:12px;
  border:1px solid var(--border);
  margin-bottom:8px;
}
.product img{
  width:60px;height:60px;border-radius:10px;
  margin-right:10px;object-fit:cover;
}
.product h4{margin:0;font-size:14px}
.product p{margin:4px 0;color:var(--green);font-weight:bold;font-size:14px}
.product-info{flex:1;margin-right:8px}
.product-actions{display:flex;align-items:center;gap:8px}

.add,.qty button{
  padding:6px 12px;border-radius:20px;
  border:1px solid var(--green);background:#fff;
  color:var(--green);font-size:13px;cursor:pointer;
}
.add:hover,.qty button:hover{background:var(--green);color:#fff}
.qty span{margin:0 8px;font-size:13px}
.out{color:red;font-size:11px;font-weight:bold}

.cart ul{padding-left:18px;margin:6px 0}

/* login */
h4{margin:0 0 8px 0;font-size:15px}
.cart input,.cart textarea{
  width:100%;padding:9px 10px;margin:5px 0;
  border-radius:8px;border:1px solid var(--border);font-size:14px;
}
.cart textarea{min-height:60px;resize:vertical}
.btn-primary, .btn-ghost{
  width:100%;padding:9px 10px;border-radius:24px;
  border:none;font-size:14px;cursor:pointer;
}
.btn-primary{
  background:var(--green);color:#fff;
}
.btn-ghost{
  background:#fff;border:1px solid var(--border);color:#333;
}
.btn-primary:hover{filter:brightness(0.95)}
.btn-ghost:hover{background:#f1f1f1}

#locStatus{
  font-size:12px;color:#555;margin-top:3px;
}

/* bottom bar */
.cart-bar{
  position:fixed;bottom:0;left:0;width:100%;
  background:#fff;padding:10px;
  box-shadow:0 -3px 10px rgba(0,0,0,.2);
}
.cart-bar button{
  width:100%;padding:12px;border:none;border-radius:30px;
  background:var(--green);color:#fff;font-size:16px;font-weight:bold;
}
.cart-bar button:disabled{opacity:.5}

/* small text */
.small{font-size:12px;color:#666}
</style>
</head>

<body>

<header>
  <div>Village Grocery</div>
  <div>üõí <span id="count">0</span></div>
</header>

<div class="container">

  <!-- LOGIN CARD (always visible) -->
  <div class="card cart">
    <h4>üë§ Login to continue</h4>
    <div id="loginBox">
      <input id="loginMobile" placeholder="+91XXXXXXXXXX">
      <div id="recaptcha-container"></div>
      <button class="btn-primary" type="button" onclick="sendOtp()">Send OTP</button>

      <input id="otpCode" placeholder="Enter OTP">
      <button class="btn-primary" type="button" onclick="verifyOtp()">Verify OTP</button>

      <div style="text-align:center;margin:8px 0;" class="small">or</div>

      <button class="btn-ghost" type="button" onclick="googleLogin()">Sign in with Google</button>
      <p class="small">After login you can see products, place orders and view your history.</p>
    </div>

    <div id="userBox" style="display:none">
      <p class="small">Logged in as <b><span id="userInfo"></span></b></p>
      <button class="btn-ghost" type="button" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- SHOP AREA: hidden until login -->
  <div id="shopArea" style="display:none">

    <div class="card search">
      <input id="search" placeholder="Search products">
    </div>

    <div class="card">
      <div class="cats">
        <button class="active" onclick="setCat('All')">All</button>
        <button onclick="setCat('Grocery')">Grocery</button>
        <button onclick="setCat('Bathroom')">Bathroom</button>
      </div>
    </div>

    <div id="products"></div>

    <div class="card cart">
      <h4>üìú Order history</h4>
      <ul id="orderHistory"></ul>
    </div>

    <div class="card cart">
      <h4>üõí Cart</h4>
      <ul id="cartList"></ul>
      <b>Total ‚Çπ<span id="total">0</span></b>
    </div>

    <div class="card cart">
      <h4>üì¶ Delivery details</h4>
      <input id="name" placeholder="Name *">
      <input id="mobile" placeholder="Mobile *">

      <button class="btn-ghost" type="button" onclick="getLocation()">üìç Share live location</button>
      <div id="locStatus"></div>

      <textarea id="address" placeholder="Address * (house / street / landmark)"></textarea>
    </div>

  </div>

</div>

<div class="cart-bar">
  <button id="placeBtn" onclick="placeOrder()">Place Order</button>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth,
  RecaptchaVerifier,
  signInWithPhoneNumber,
  signOut,
  onAuthStateChanged,
  GoogleAuthProvider,
  signInWithPopup
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; /* modular web auth [web:12][web:6] */

const firebaseConfig = {
  apiKey: "AIzaSyCYDLsQLFvuTV1N0mXtZFVYcSQqOkGfCrE",
  authDomain: "grocery-orders-3ce26.firebaseapp.com",
  projectId: "grocery-orders-3ce26",
  storageBucket: "grocery-orders-3ce26.appspot.com",
  messagingSenderId: "786501136156",
  appId: "1:786501136156:web:9277a2f7ef937deff1d4d9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const googleProvider = new GoogleAuthProvider();

let data = [];
let cart = {};
let cat = 'All';

const list = document.getElementById("products");
const search = document.getElementById("search");
const cartList = document.getElementById("cartList");
const total = document.getElementById("total");
const count = document.getElementById("count");
const nameEl = document.getElementById("name");
const mobileEl = document.getElementById("mobile");
const addressEl = document.getElementById("address");
const locStatus = document.getElementById("locStatus");
const placeBtn = document.getElementById("placeBtn");

const loginMobile = document.getElementById("loginMobile");
const otpCode = document.getElementById("otpCode");
const loginBox = document.getElementById("loginBox");
const userBox = document.getElementById("userBox");
const userInfo = document.getElementById("userInfo");
const orderHistoryEl = document.getElementById("orderHistory");
const shopArea = document.getElementById("shopArea");

// geolocation
let currentLat = null;
let currentLng = null;

// reCAPTCHA + OTP
let recaptchaVerifier;
let confirmationResultGlobal = null;

// init invisible reCAPTCHA for phone auth [web:1]
function initRecaptcha() {
  recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
    size: 'invisible'
  });
}
initRecaptcha();

// products listener
const productsRef = collection(db, "products");
onSnapshot(productsRef, (snapshot) => {
  data = snapshot.docs.map(doc => {
    const d = doc.data();
    return {
      id: doc.id,
      name: d.Name,
      price: d.price,
      cat: d.cat,
      img: d.img,
      inStock: d.stock,
      unit: d.unit
    };
  });
  render();
}, (error) => console.error(error));

function render(){
  if (!list) return;
  list.innerHTML = '';
  const txt = (search?.value || "").toLowerCase();

  data
    .filter(p =>
      p.name.toLowerCase().includes(txt) &&
      (cat === 'All' || p.cat === cat)
    )
    .forEach(p => {
      const qty = cart[p.id]?.qty || 0;
      list.innerHTML += `
      <div class="card product">
        <img src="${p.img}">
        <div class="product-info">
          <h4>${p.name} ${p.unit ? '('+p.unit+')' : ''}</h4>
          <p>‚Çπ${p.price}</p>
          ${p.inStock ? '' : '<div class="out">OUT OF STOCK</div>'}
        </div>

        <div class="product-actions">
          <div class="qty" style="display:${qty > 0 ? 'block' : 'none'}">
            <button onclick="chg('${p.id}',-1)">‚àí</button>
            <span>${qty}</span>
            <button onclick="chg('${p.id}',1)">+</button>
          </div>

          ${p.inStock && qty === 0
            ? `<button class="add" onclick="add('${p.id}')">Add</button>`
            : ''
          }
        </div>
      </div>`;
    });

  if (data.length === 0) {
    list.innerHTML = '<div class="card small">No products found.</div>';
  }
}

window.setCat = c => {
  cat = c;
  document.querySelectorAll('.cats button')
    .forEach(b => b.classList.toggle('active', b.textContent === c));
  render();
};

window.add = id => {
  const product = data.find(p => p.id === id);
  if (!product) return;
  if (!cart[id]) {
    cart[id] = { qty: 1, price: product.price, name: product.name };
  } else {
    cart[id].qty += 1;
  }
  renderCart();
  render();
};

window.chg = (id, d) => {
  if (!cart[id]) return;
  cart[id].qty += d;
  if (cart[id].qty <= 0) delete cart[id];
  renderCart();
  render();
};

function renderCart(){
  cartList.innerHTML=''; 
  let t = 0, c = 0;
  for(let i in cart){
    t += cart[i].qty * cart[i].price;
    c += cart[i].qty;
    cartList.innerHTML += `<li>${cart[i].name} √ó ${cart[i].qty}</li>`;
  }
  total.textContent = t;
  count.textContent = c;
}

// PHONE AUTH [web:1]
window.sendOtp = async () => {
  const phone = loginMobile.value.trim();
  if (!phone) {
    alert("Enter mobile with country code (e.g. +91...)");
    return;
  }
  try {
    confirmationResultGlobal = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);
    alert("OTP sent");
  } catch (e) {
    console.error(e);
    alert(e.message);
  }
};

window.verifyOtp = async () => {
  if (!confirmationResultGlobal) {
    alert("Click 'Send OTP' first");
    return;
  }
  try {
    await confirmationResultGlobal.confirm(otpCode.value.trim());
  } catch (e) {
    console.error(e);
    alert("Wrong OTP");
  }
};

// GOOGLE AUTH [web:6]
window.googleLogin = async () => {
  try {
    await signInWithPopup(auth, googleProvider);
  } catch (e) {
    console.error(e);
    alert(e.message);
  }
};

window.logout = async () => {
  try {
    await signOut(auth);
  } catch (e) {
    console.error(e);
  }
};

// auth state: show/hide shop [web:12]
onAuthStateChanged(auth, (user) => {
  if (user) {
    loginBox.style.display = "none";
    userBox.style.display = "block";
    userInfo.textContent = user.phoneNumber || user.email || "User";

    shopArea.style.display = "block";
    placeBtn.disabled = false;
    loadOrderHistory(user.uid);
  } else {
    loginBox.style.display = "block";
    userBox.style.display = "none";
    userInfo.textContent = "";

    shopArea.style.display = "none";
    placeBtn.disabled = true;
    orderHistoryEl.innerHTML = "<li class='small'>Login to see your orders</li>";
  }
});

// ORDER HISTORY [web:43]
function loadOrderHistory(userId) {
  if (!userId) {
    orderHistoryEl.innerHTML = "<li class='small'>Login to see your orders</li>";
    return;
  }

  const q = query(
    collection(db, "orders"),
    where("userId", "==", userId),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snap) => {
    if (snap.empty) {
      orderHistoryEl.innerHTML = "<li class='small'>No orders yet</li>";
      return;
    }

    orderHistoryEl.innerHTML = "";
    snap.forEach(doc => {
      const o = doc.data();
      const itemsText = Object.values(o.items || {})
        .map(it => `${it.name} x ${it.qty}`)
        .join(", ");

      const created = o.createdAt?.toDate
        ? o.createdAt.toDate().toLocaleString()
        : "";

      const li = document.createElement("li");
      li.className = "small";
      li.textContent = `${created} - ${itemsText} [${o.status}]`;
      orderHistoryEl.appendChild(li);
    });
  }, (err) => {
    console.error(err);
    orderHistoryEl.innerHTML = "<li class='small'>Error loading orders</li>";
  });
}

// geolocation
window.getLocation = () => {
  if (!navigator.geolocation) {
    locStatus.textContent = "Geolocation not supported in this browser.";
    return;
  }
  locStatus.textContent = "Getting location...";
  navigator.geolocation.getCurrentPosition(
    (position) => {
      currentLat = position.coords.latitude;
      currentLng = position.coords.longitude;
      locStatus.textContent = `Location captured ‚úÖ (${currentLat.toFixed(5)}, ${currentLng.toFixed(5)})`;
    },
    (error) => {
      locStatus.textContent = "Unable to get location. Please allow location permission.";
      console.warn(error);
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
};

window.placeOrder = async () => {
  if(!nameEl.value || !mobileEl.value || !addressEl.value || !Object.keys(cart).length){
    alert("Fill all details & add at least one item");
    return;
  }

  const user = auth.currentUser;
  if (!user) {
    alert("Please login first");
    return;
  }

  await addDoc(collection(db,"orders"),{
    name: nameEl.value,
    mobile: mobileEl.value,
    address: addressEl.value,
    items: cart,
    status:"NEW",
    createdAt: serverTimestamp(),
    location: (currentLat !== null && currentLng !== null) ? {
      lat: currentLat,
      lng: currentLng
    } : null,
    userId: user.uid,
    userPhone: user.phoneNumber || null,
    userEmail: user.email || null
  });

  alert("‚úÖ Order placed");
  cart = {};
  renderCart();
  render();
  nameEl.value = '';
  mobileEl.value = '';
  addressEl.value = '';
  locStatus.textContent = '';
  currentLat = null;
  currentLng = null;
};

if (search) search.oninput = render;
</script>

</body>
</html>
